<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Manual Alert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #dc2626;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3b82f6;
            padding-left: 10px;
        }
        .log-error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        .log-success {
            border-left-color: #10b981;
            background: #d1fae5;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status-ok {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <h1>üö® Manual Alert Test Tool</h1>
    <p>This tool helps debug manual alert sending issues.</p>

    <div id="status"></div>

    <div>
        <button onclick="testServerHealth()">1. Test Server Health</button>
        <button onclick="testEndpoint()">2. Test Alert Endpoint</button>
        <button onclick="testWithAuth()" id="authBtn" disabled>3. Test With Auth</button>
        <button onclick="sendManualAlert()" id="alertBtn" disabled>4. Send Manual Alert</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="log" id="log"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentUser = null;

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCQV7AgyYaBNC20XTzGeVkGw2kThauFWHA",
            authDomain: "silentsos-cd4f9.firebaseapp.com",
            projectId: "silentsos-cd4f9",
            storageBucket: "silentsos-cd4f9.firebasestorage.app",
            messagingSenderId: "677085456378",
            appId: "1:677085456378:web:3aa081735537a84263a643"
        };

        firebase.initializeApp(firebaseConfig);

        // Check auth state
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                log(`‚úÖ User authenticated: ${user.email}`, 'success');
                document.getElementById('authBtn').disabled = false;
                document.getElementById('alertBtn').disabled = false;
                updateStatus('Authenticated', 'ok');
            } else {
                log('‚ö†Ô∏è No user authenticated. Please sign in to the main app first.', 'error');
                updateStatus('Not Authenticated', 'error');
            }
        });

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status status-${type}`;
            statusDiv.textContent = message;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testServerHealth() {
            log('Testing server health...');
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                log(`‚úÖ Server is running: ${JSON.stringify(data)}`, 'success');
                updateStatus('Server OK', 'ok');
            } catch (error) {
                log(`‚ùå Server health check failed: ${error.message}`, 'error');
                updateStatus('Server Error', 'error');
            }
        }

        async function testEndpoint() {
            log('Testing alert endpoint...');
            try {
                const response = await fetch(`${API_URL}/test-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test: 'data', timestamp: new Date().toISOString() })
                });
                const data = await response.json();
                log(`‚úÖ Test endpoint response: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log(`‚ùå Test endpoint failed: ${error.message}`, 'error');
            }
        }

        async function testWithAuth() {
            if (!currentUser) {
                log('‚ùå No user authenticated', 'error');
                return;
            }

            log('Getting auth token...');
            try {
                const token = await currentUser.getIdToken();
                log(`‚úÖ Got auth token: ${token.substring(0, 20)}...`, 'success');

                log('Testing authenticated endpoint...');
                const response = await fetch(`${API_URL}/test-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        test: 'authenticated data',
                        userId: currentUser.uid,
                        email: currentUser.email
                    })
                });
                const data = await response.json();
                log(`‚úÖ Authenticated test response: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log(`‚ùå Authenticated test failed: ${error.message}`, 'error');
            }
        }

        async function sendManualAlert() {
            if (!currentUser) {
                log('‚ùå No user authenticated', 'error');
                return;
            }

            log('=== SENDING MANUAL ALERT ===');
            log(`User: ${currentUser.uid} (${currentUser.email})`);

            try {
                // Get auth token
                log('Getting auth token...');
                const token = await currentUser.getIdToken();
                log('‚úÖ Auth token obtained');

                // Prepare emergency data
                const emergencyData = {
                    sensorData: {
                        motion: {
                            acceleration: { x: 0, y: 0, z: 0 },
                            rotationRate: { alpha: 0, beta: 0, gamma: 0 },
                            magnitude: 0,
                            variance: 0,
                            inactivityDuration: 0,
                            suddenImpact: null,
                            stillnessDuration: 0
                        },
                        audio: {
                            silenceDuration: 0,
                            breathingIrregularity: 0,
                            distressSound: null,
                            amplitude: { averageAmplitude: 0, suddenDrop: false },
                            rmsAmplitude: 0
                        },
                        activity: {
                            inactivityDuration: 0,
                            lastMovement: Date.now(),
                            level: 0
                        }
                    },
                    location: {
                        latitude: null,
                        longitude: null,
                        accuracy: null,
                        safeZones: null,
                        isolation: null
                    },
                    contextData: {
                        timestamp: Date.now(),
                        timeOfDay: new Date().getHours(),
                        environment: {
                            noiseLevel: 0.5,
                            lightLevel: 0.5,
                            temperature: 20
                        },
                        userPatterns: {
                            usualActivityLevel: 0.7,
                            locationDeviation: 0.3,
                            currentActivity: 0
                        },
                        crowdSignals: [],
                        note: 'Manual emergency alert from test tool'
                    },
                    timestamp: new Date().toISOString(),
                    confidence: 100,
                    manual: true
                };

                log('Sending emergency report...');
                log(`Endpoint: ${API_URL}/emergency/report`);

                const response = await fetch(`${API_URL}/emergency/report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(emergencyData)
                });

                log(`Response status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Server error response: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log(`‚úÖ SUCCESS! Emergency ID: ${result.emergencyId}`, 'success');
                log(`Score: ${result.score}, Manual: ${result.manual}`, 'success');
                log(JSON.stringify(result, null, 2), 'success');

                updateStatus('Manual Alert Sent Successfully!', 'ok');
                alert('‚úÖ Manual alert sent successfully!\n\nEmergency ID: ' + result.emergencyId);

            } catch (error) {
                log(`‚ùå FAILED: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                updateStatus('Manual Alert Failed', 'error');
                alert('‚ùå Manual alert failed!\n\n' + error.message);
            }

            log('=== END MANUAL ALERT ===');
        }
    </script>
</body>
</html>
